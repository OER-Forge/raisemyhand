# RaiseMyHand Development Environment
# Runs on port 8001 with persistent data for classroom use
#
# Quick Start:
#   1. Copy .env.example to .env and configure
#   2. docker compose -f docker-compose.dev.yml up -d
#
# To stop (keeps data):
#   docker compose -f docker-compose.dev.yml down
#
# To reset (deletes data):
#   docker compose -f docker-compose.dev.yml down -v

services:
  dev:
    build: .
    container_name: raisemyhand-dev
    ports:
      - "8001:8000"
    volumes:
      - dev-data:/app/data
      - dev-logs:/app/logs
      - ./secrets:/app/secrets:ro
    env_file:
      - .env
    environment:
      # Override port for internal use (exposed as 8001)
      - HOST=0.0.0.0
      - PORT=8000
      - BASE_URL=${BASE_URL:-http://localhost:8001}

      # Development mode settings
      - DEBUG=false
      - DATABASE_URL=sqlite:///./data/raisemyhand.db

      # Load admin password from Docker secrets if available
      - ADMIN_PASSWORD_FILE=/run/secrets/admin_password

    secrets:
      - admin_password

    command: >
      sh -c "
        echo 'ğŸ“ Starting RaiseMyHand DEVELOPMENT Environment' &&
        echo 'ğŸ“ Access at: ${BASE_URL:-http://localhost:8001}' &&
        echo '' &&
        if [ -f /run/secrets/admin_password ]; then
          export ADMIN_PASSWORD=$$(cat /run/secrets/admin_password)
          echo 'ğŸ” Loaded admin password from secrets'
        fi &&
        echo 'ğŸ—„ï¸  Initializing database...' &&
        python init_db_v2.py &&
        echo 'âœ… Database ready' &&
        echo '' &&
        echo 'ğŸš€ Starting server...' &&
        uvicorn main:app --host 0.0.0.0 --port 8000
      "

    restart: unless-stopped

volumes:
  dev-data:
    driver: local
  dev-logs:
    driver: local

secrets:
  admin_password:
    file: ./secrets/admin_password.txt
